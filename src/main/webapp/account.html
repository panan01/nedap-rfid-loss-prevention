<!DOCTYPE html>
<html lang="en" class="app-html">
    <head>
        <link rel="stylesheet" href="font/fonts.css">
        <link rel="stylesheet" href="css/main.css">
        <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet">

        <script src="js/jquery.js"></script>
        <script src="js/commandbar.js"></script>
        <script src="js/app.js"></script>

        <title>Account</title>

        <style>
            .logo::before {
                display: block;
                width: 100%;
                height: 100%;
                background-image: url("svg/nedap_inline_logo_on_blue.svg");
                background-position: center;
                background-size: contain;
                background-repeat: no-repeat;
                content: "";
                box-sizing: border-box;
                border: 10px solid transparent;
            }
        </style>
    </head>

    <body class="app">
        <div class="app-bar">
            <div class="app-bar-inner">
                <div class="logo"><!-- automatically styled with logo by CSS --></div>
                <input class="searchbar" id="searchbar" type="text" placeholder="Type here to search">
                <div class="profile-icon" id="#profile"></div>
            </div>
        </div>

        <div class="app-nav" id="nav">
            <a href="./dashboard.html"><div class="nav-entry" -icon="dashboard" -name="Dashboard"></div></a>
            <a href="./account.html"><div class="nav-entry nav-current" -icon="account_circle" -name="Account"></div></a>
            <a href="./data_reports.html"><div class="nav-entry" -icon="file_upload" -name="Data"></div></a>
            <a href="./settings.html"><div class="nav-entry" -icon="tune" -name="Settings"></div></a>
            <a href="./admin_overview.html"><div class="nav-entry" -icon="admin_panel_settings" -name="Admin"></div></a>
        </div>

        <div class="app-content" id="app">
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Your account</h1>
                </div>

                <div class="flex vertical-700">
                    <div class="card">
                        <div class="card-header">
                            User
                        </div>
                        <div class="card-content" id="username">
                            [User name placeholder]
                        </div>
                        <br>
                        <div class="card-header">
                            Access level
                        </div>
                        <div class="card-content" id="access_level">
                            [User access level placeholder]
                        </div>
                        <br>
                        <div class="card-header">
                            E-mail
                        </div>
                        <div class="card-content" id="email">
                            [User mail placeholder]
                        </div>
                        <br>
                        <div class="card-header">
                            Available stores
                        </div>
                        <div class="card-content" id="accessible_stores">
                            [Accessible stores placeholder]
                        </div>
                        <script>
                            function fillInData() {
                                // also checks logged in
                                try {
                                    const token = document.cookie.split('; ').find(row => row.startsWith('token=')).split('=', 2)[1];
                                    const email = document.cookie.split('; ').find(row => row.startsWith('email=')).split('=', 2)[1];
                                    $.ajax({
                                        url: "rest/account/" + email,
                                        method: 'GET',
                                        headers: {'Authorization': token},
                                        dataType: "json",
                                        success: function(response) {
                                            let usernameElement = document.getElementById("username");
                                            usernameElement.innerText = response.first_name + ' ' + response.last_name;
                                            let accessLevelElement = document.getElementById("access_level");
                                            accessLevelElement.innerText = response.type;
                                            let emailElement = document.getElementById("email");
                                            emailElement.innerText = email;
                                        },
                                        error: function(jqXHR, textStatus, errorThrown) {
                                            console.log("unsuccessful request");
                                            window.location.href = "login.html";
                                        }
                                    });
                                    $.ajax({
                                        url: "rest/app",
                                        method: 'POST',
                                        dataType: 'json',
                                        data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;0-6|store_access.store_id|-2|store_access:users|-7|" + email + "|-0-0-0-0",
                                        success: function (response) {
                                            let accessibleStoresElement = document.getElementById("accessible_stores");
                                            let text = "";
                                            for (let item of response) {
                                                text += item.store_id + ", ";
                                            }
                                            text = text.slice(0, text.length-2);
                                            accessibleStoresElement.innerText = text;
                                        }
                                    });
                                    return null;
                                } catch (err) {
                                    if (err instanceof TypeError) {
                                        window.location.href = "login.html";
                                    } else {
                                        throw err;
                                    }
                                }
                            }
                            window.onload = fillInData();
                        </script>
                    </div>
                </div>
            </main>
        </div>
    </body>

    <script>
        let dispatcher = new CommandDispatcher([
            {
                aliases: ["add"],
                args: [{ name: "$main", params: [ArgTypes.float, ArgTypes.float] }],
                trigger: function(result) {
                    alert(result.value("$main", 0) + result.value("$main", 1));
                }
            }, {
                aliases: ["sub"],
                args: [{ name: "$main", params: [ArgTypes.float, ArgTypes.float] }],
                trigger: function(result) {
                    alert(result.value("$main", 0) - result.value("$main", 1));
                }
            }, {
                aliases: ["hello"],
                trigger: function(result) {
                    alert("Hello world!");
                }
            }, {
                aliases: ["say"],
                args: [{ name: "$main", params: [ArgTypes.string] }],
                trigger: function(result) {
                    alert(result.value("$main"));
                }
            }, {
                aliases: ["arg"],
                args: [
                    { name: "a", params: [ArgTypes.string], required: true },
                    { name: "b", params: [ArgTypes.int] }
                ],
                trigger: function(result) {
                    if (result.has("b")) {
                        alert(result.value("a") + result.value("b"));
                    } else {
                        alert(result.value("a"));
                    }
                }
            }
        ]);


        function makeCommandBar(opts) {
            var element = opts.element;
            var $element = $(element);

            $element.on("input", (event) => {
                if ($element.val()[0] === '/') {
                    $element.addClass("command-mode");

                    let parseResult = dispatcher.parse($element.val().substring(1));
                    if (parseResult.errors.length > 0) {
                        $element.addClass("command-error");
                    } else {
                        $element.removeClass("command-error");
                    }
                } else {
                    $element.removeClass("command-mode");
                    $element.removeClass("command-error");
                }
            });

            $element.keypress((event) => {
                var key = event.which || event.keyCode;

                if (key === 13) { // enter
                    event.stopPropagation();
                    event.preventDefault();

                    if ($element.val()[0] === '/') {
                        $element.addClass("command-mode");

                        let parseResult = dispatcher.parse($element.val().substring(1));
                        if (parseResult.errors.length > 0) {
                            $element.addClass("command-error");
                            console.log(parseResult.errors);
                        } else {
                            $element.val("");
                            $element.removeClass("command-mode");
                            $element.removeClass("command-error");
                            parseResult.execute();
                        }
                    } else {
                        $element.removeClass("command-mode");
                        $element.removeClass("command-error");
                    }
                }
            });
        }

        $(function() {
            makeCommandBar({
                element: document.getElementById("searchbar")
            });
        });
    </script>
</html>
