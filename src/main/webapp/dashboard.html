<!DOCTYPE html>
<html class="app-html" lang="en" xmlns="http://www.w3.org/1999/html">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="font/fonts.css">
        <link rel="stylesheet" href="css/main.css">
        <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script src="js/jquery.js"></script>
        <script src="js/commandbar.js"></script>
        <script src="js/app.js"></script>
        <script src="js/chart.js"></script>
        <script src="js/sorttable.js"></script>
        <script src="js/commands.js"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

        <title>Dashboard</title>

        <style>
            .logo::before {
                display: block;
                width: 100%;
                height: 100%;
                background-image: url("svg/nedap_inline_logo_on_blue.svg");
                background-position: center;
                background-size: contain;
                background-repeat: no-repeat;
                content: "";
                box-sizing: border-box;
                border: 10px solid transparent;
            }
            #navbarLinks {
                display: none;
                min-width: 0;
                text-align: center;
                vertical-align: middle;
                background-color: #023A4F;

            }
            #navbarLinks a {
                text-decoration: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                display: table-cell;
                position: relative;
                vertical-align: middle;
                font-size: 20px;
                background-color: #023A4F;
                color: white;
            }
            #navbarLinks a:hover {
                background-color: #01151d;
            }
            #icon {
                position: relative;
                float: right;
                color: white;
                background-color: #FF6C37;
            }
            #icon:hover {
                background-color: #FF4710;
            }
            #icon div {
                text-align: center;
            }
            #icon div span {
                font-size: 48px;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        </style>

        <script src="js/dashboard.js"></script>
    </head>

    <body class="app">
        <div class="app-bar">
            <div class="app-bar-inner" style="display: inline-flex">
                <div class="logo"> </div>
                <input class="searchbar" id="searchbar" type="text" placeholder="Type here to search">
                <a onclick="navbarMenu()" id="icon">
                    <div class="profile-icon">
                        <span class="icon">account_circle</span>
                    </div>
                </a>
                <div id="navbarLinks">
                    <a onclick="logOut()">Log out</a>
                </div>
            </div>
        </div>

        <div class="app-nav" id="nav">
            <a href="./dashboard.html"><div class="nav-entry nav-current" -icon="dashboard" -name="Dashboard"></div></a>
            <a href="./account.html"><div class="nav-entry" -icon="account_circle" -name="Account"></div></a>
            <a href="./data_reports.html"><div class="nav-entry" -icon="file_upload" -name="Data"></div></a>
            <a href="./settings.html"><div class="nav-entry" -icon="tune" -name="Settings"></div></a>
            <a href="./admin_overview.html"><div class="nav-entry" -icon="admin_panel_settings" -name="Admin"></div></a>
        </div>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
            </div>

        </main>
        <!-- OVERALL INFORMATION CARDS -->
        <div class="app-content" id="app">
            <div class="flex vertical-700">
                <div class="flex">
                    <div class="card">
                        <div class="card-header">Overall store performance</div>
                        <div class="card-content">
                            The following cards display useful information about stores and their overall loss prevention performances in a quick overview.
                        </div>
                    </div>
                </div>
            </div>
            <!-- RED ORANGE GREEN NUMBER OF THEFTS CARDS -->
            <div class="flex vertical-700">
                <div class="card card-error">
                    <div class="card-header">Most amount of thefts</div>
                    <div class="card-content">
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|alarm.store_id|-2|alarm:article|-1|article.id:=:alarm.article_id|-1|alarm.store_id|-0-1|alarm.store_id|-1|1|",
                                    success: function(response) {
                                        let array = [[ 'StoreID', 'theftAmount'
                                        ]];
                                        for (let item of response){
                                            array.push([item.store_id.toString(), item.count]);
                                        }
                                        document.getElementById("storeID_MOST").innerHTML = array[1][0];
                                        document.getElementById("theftAmount_MOST").innerHTML = array[1][1];
                                    }
                                })
                            });
                        </script>
                        Store <b><span id="storeID_MOST"></span></b> has <b><span id="theftAmount_MOST"></span></b> stolen items.<br>
                        The average is <b><span id="theftAmount_AVERAGE_MOST"></span></b> stolen items per store.
                    </div>
                </div>
                <div class="card card-warning">
                    <div class="card-header">Increasing amount of thefts</div>
                    <div class="card-content">
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|alarm.store_id|-2|alarm:article|-1|article.id:=:alarm.article_id|-1|alarm.store_id|-0-1|alarm.store_id|-0",
                                    success: function(response) {
                                        let array = [[ 'StoreID', 'theftAmount'
                                        ]];
                                        var theftSum = 0;
                                        for (let item of response){
                                            array.push([item.store_id.toString(), item.count]);
                                            theftSum += item.count;
                                        }
                                        var average = (theftSum / 53).toFixed(0);
                                        document.getElementById("theftAmount_AVERAGE_MOST").innerHTML = average;
                                        document.getElementById("theftAmount_AVERAGE_LOWEST").innerHTML = average;

                                        var amountStore1 = array[1][1]
                                        var amountStore2 = array[2][1]
                                        var percentageDifference = (((amountStore1-amountStore2)/((amountStore1+amountStore2)/2))*100).toFixed(2)
                                        document.getElementById("percentageDifference_INCREASING").innerHTML = percentageDifference.toString();
                                        document.getElementById("storeID_INCREASING").innerHTML = array[2][0];
                                        document.getElementById("theftAmount_INCREASING").innerHTML = array[2][1];
                                    }
                                })
                            });
                        </script>
                        Store <b><span id="storeID_INCREASING"></span></b> has <b><span id="theftAmount_INCREASING"></span></b> stolen items.<br>
                        This store has increased and needs to increase <b><span id="percentageDifference_INCREASING"></span>%</b> to become the store with most stolen items.
                    </div>
                </div>
                <div class="card card-success">
                    <div class="card-header">Lowest amount of thefts</div>
                    <div class="card-content">
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|alarm.store_id|-2|alarm:article|-1|article.id:=:alarm.article_id|-1|alarm.store_id|-0-3|alarm.store_id|-1|1|",
                                    success: function(response) {
                                        let array = [[ 'StoreID', 'theftAmount'
                                        ]];
                                        for (let item of response){
                                            array.push([item.store_id.toString(), item.count]);
                                        }
                                        document.getElementById("storeID_LOWEST").innerHTML = array[1][0];
                                        document.getElementById("theftAmount_LOWEST").innerHTML = array[1][1];
                                    }
                                })
                            });
                        </script>
                        Store <b><span id="storeID_LOWEST"></span></b> has <b><span id="theftAmount_LOWEST"></span></b> stolen items.<br>
                        The average is <b><span id="theftAmount_AVERAGE_LOWEST"></span></b> stolen items per store.
                    </div>
                </div>
            </div>
            <!-- RED ORANGE GREEN NUMBER OF CATEGORIES THEFTS -->
            <div class="flex vertical-700">
                <div class="card card-error">
                    <div class="card-header">Most thefts in category</div>
                    <div class="card-content">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                        incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
                        exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
                <div class="card card-warning">
                    <div class="card-header">Increasing thefts in category</div>
                    <div class="card-content">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                        incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
                        exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
                <div class="card card-success">
                    <div class="card-header">Lowest thefts in category</div>
                    <div class="card-content">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                        incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
                        exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>

            <!-- GRAPHS EXPLANATION CARD -->
            <div class="flex vertical-700">
                <div class="flex">
                    <div class="card">
                        <div class="card-header">Graphs</div>
                        <div class="card-content">
                            The following graphs display detailed and useful information about stores and their overall loss prevention performances. Graphs can be used for deeper analysis and better understanding of stores' performances.
                        </div>
                    </div>
                </div>
            </div>
            <!-- DASHBOARD GRAPHS -->
            <div class="flex vertical-700">
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-header">TO BE IMPLEMENTED</div>
                        <div class="card-content">
                            Examples:
                        </div>
                        <div class="card-content">
                            One specific store ID with most stolen items or one specific category with most stolen items in certain week.
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">TO BE IMPLEMENTED</div>
                        <div class="card-content">
                            Examples:
                        </div>
                        <div class="card-content">
                            Average cost of a stolen item or total loss in certain time period.
                        </div>
                    </div>
                </div>

                <!-- CHART -->
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-image" id="chart-canvas-1" style="height: 400px">
                        </div>
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|article.category|-1|article|-0-1|article.category|-0-1|article.category|-0",
                                    success: function(response) {
                                        let array = [[
                                            'Category', 'Amount',
                                        ]];
                                        for (let item of response){
                                            array.push([item.category.toString(), item.count]);
                                        }
                                        let data = google.visualization.arrayToDataTable(array);
                                        let options = {
                                            backgroundColor: {
                                                fill: '#F4F4F4'
                                            },
                                            colors: ['#2C7998'],
                                            chartArea: {
                                                top: 20,
                                                left: 50,
                                                bottom: 50,
                                                height: '100%',
                                                width: '100%'
                                            },
                                            hAxis: {
                                                gridlines: {
                                                    count: 0
                                                },
                                                viewWindow: {
                                                    min: 0,
                                                    max: 65
                                                },
                                                showTextEvery: 1,
                                                title: 'Category Number',
                                                slantedText: true,
                                                slantedTextAngle: 90
                                            },
                                            vAxis: {
                                                viewWindow: {
                                                    max: 1600
                                                }
                                            },
                                            legend: {
                                                position: 'in',
                                                alignment: 'end'
                                            }
                                        };
                                        let chart = new google.visualization.ColumnChart(document.getElementById('chart-canvas-1'));

                                        chart.draw(data, options);
                                    }
                                });

                            });
                        </script>
                        <div class="card-header">Stolen items</div>
                        <div class="card-content">
                            An overview of all items ever stolen.
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex vertical-800">
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-image" id="chart-canvas-2" style="height: 400px; width: 100%">
                        </div>
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|article.price|-1|article|-0-1|article.price|-0-1|article.price|-0",
                                    success: function(response) {
                                        let array = [[
                                            {label: 'Price', type: 'number'},
                                            {label: 'Amount', type: 'number'},
                                        ]];
                                        for (let item of response){
                                            if (item.count > 50 && item.price > 0) {
                                                array.push([Math.round(item.price), item.count]);
                                            }
                                        }
                                        let data = google.visualization.arrayToDataTable(array);
                                        let formatter = new google.visualization.NumberFormat({prefix: '€'});
                                        formatter.format(data, 0);
                                        let options = {
                                            backgroundColor: {
                                                fill: '#F4F4F4'
                                            },
                                            colors: ['#2C7998'],
                                            chartArea: {
                                                top: 20,
                                                left: 50,
                                                bottom: 50,
                                            },
                                            hAxis: {
                                                gridlines: {
                                                    count: 0
                                                },
                                                title: 'Price in €'
                                            },
                                            legend: {
                                                position: 'in',
                                                alignment: 'end'
                                            },
                                            bar: {
                                                groupWidth: 5
                                            },
                                        };
                                        let chart = new google.visualization.ColumnChart(document.getElementById('chart-canvas-2'));

                                        chart.draw(data, options);
                                    }
                                });

                            });
                        </script>
                        <div class="card-header">Stolen items at price</div>
                        <div class="card-content">
                            An overview of all things stolen at a set price.
                        </div>
                    </div>
                </div>

                <div class="flex vertical">
                    <div class="card">
                        <div class="card-image" id="chart-canvas-3" style="height: 400px">
                        </div>
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|alarm.store_id|-2|alarm:article|-1|article.id:=:alarm.article_id|-1|alarm.store_id|-0-1|alarm.store_id|-0",
                                    success: function(response) {
                                        let array = [[
                                            'Store', 'Amount',
                                        ]];
                                        for (let item of response){
                                            array.push([item.store_id.toString(), item.count]);
                                        }
                                        let data = google.visualization.arrayToDataTable(array);
                                        let options = {
                                            backgroundColor: {
                                                fill: '#F4F4F4'
                                            },
                                            colors: ['#2C7998'],
                                            chartArea: {
                                                top: 20,
                                                left: 50,
                                                bottom: 80,
                                                height: '70%',
                                                width: '100%'
                                            },
                                            hAxis: {
                                                title: 'Store ID',
                                                slantedText: true,
                                                slantedTextAngle: 90,
                                                showTextEvery: 1,
                                                maxAlternation: 5,
                                            },
                                            bar: {
                                                groupWidth: 3
                                            },
                                            legend: {
                                                position: 'in',
                                                alignment: 'end'
                                            },
                                        };
                                        let chart = new google.visualization.ColumnChart(document.getElementById('chart-canvas-3'));

                                        chart.draw(data, options);
                                    }
                                });

                            });
                        </script>
                        <div class="card-header">Stolen items at each store</div>
                        <div class="card-content">
                            An overview of all items ever stolen for each store.
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div id="mapid" style="height: 400px"></div>
                <script>
                   $.ajax({
                        url: "rest/app",
                        method: 'POST',
                        dataType: 'json',
                        data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-2-1|store|-0-0-0-0-0",
                        success: function(locationResult) {
                            let array = [[
                                {label: 'Store ID', type: 'number'},
                                {label: 'Longitude', type: 'number'},
                                {label: 'Latitude', type: 'number'},
                            ]];
                            for (let item of locationResult){
                                array.push([item.store_id, item.longitude, item.latitude]);
                            }
                            var mapData = locationResult;

                            let grouped = {};

                            for (let d of mapData) {
                                if (d.latitude !== null && d.longitude !== null) {
                                    let key = d.latitude + ";" + d.longitude;

                                    let collection = grouped[key];
                                    if (!collection) {
                                        collection = {coords: [d.latitude, d.longitude], ids: []};
                                    }

                                    collection.ids.push(d.store_id);
                                    grouped[key] = collection;
                                }
                            }


                            var mymap = L.map('mapid').setView([38.3, -3.5], 4);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(mymap);

                            for (let k in grouped) {
                                let d = grouped[k];
                                let icon = d.ids.length === 1 ? markerIcons[Math.floor(Math.random() * 4)] : multiMarkerIcon;
                                let marker = L.marker(d.coords, {icon: icon}).addTo(mymap);

                                let idHtml = "<b>" + d.ids.length + " store" + (d.ids.length === 1 ? "" : "s") + "</b>"

                                for (let id of d.ids) {
                                    idHtml += "<br>" + id;
                                }

                                marker.bindPopup(idHtml);
                            }
                        }
                   })
                </script>
                <div class="card-header">Map</div>
            </div>
        </div>

        <div class="modal" id="test-modal">
            <div class="card card-error">
                <div class="card-header">I'm a big and important modal</div>
                <div class="card-content">
                    This is a big warning modal that wants you to be sure you have seen my information.
                </div>
                <div class="card-content align-right">
                    <button class="btn-primary" onclick="app.hideModal(this)">Close</button>
                </div>
            </div>
        </div>

        <div class="snackbar-container">
        </div>
    </body>
</html>
