<!DOCTYPE html>
<html class="app-html" lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="font/fonts.css">
        <link rel="stylesheet" href="css/main.css">
        <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script src="js/jquery.js"></script>
        <script src="js/commandbar.js"></script>
        <script src="js/app.js"></script>
        <script src="js/chart.js"></script>
        <script src="js/sorttable.js"></script>
        <script src="js/commands.js"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

        <title>Dashboard</title>

        <style>
            .logo::before {
                display: block;
                width: 100%;
                height: 100%;
                background-image: url("svg/nedap_inline_logo_on_blue.svg");
                background-position: center;
                background-size: contain;
                background-repeat: no-repeat;
                content: "";
                box-sizing: border-box;
                border: 10px solid transparent;
            }
            #navbarLinks {
                display: none;
                min-width: 0;
                text-align: center;
                vertical-align: middle;
                background-color: #023A4F;

            }
            #navbarLinks a {
                text-decoration: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                display: table-cell;
                position: relative;
                vertical-align: middle;
                font-size: 20px;
                background-color: #023A4F;
                color: white;
            }
            #navbarLinks a:hover {
                background-color: #01151d;
            }
            #icon {
                position: relative;
                float: right;
                color: white;
                background-color: #FF6C37;
            }
            #icon:hover {
                background-color: #FF4710;
            }
            #icon div {
                text-align: center;
            }
            #icon div span {
                font-size: 48px;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        </style>

        <script src="js/dashboard.js"></script>
    </head>

    <body class="app">
        <div class="app-bar">
            <div class="app-bar-inner" style="display: inline-flex">
                <div class="logo"> </div>
                <input class="searchbar" id="searchbar" type="text" placeholder="Type here to search">
                <a onclick="navbarMenu()" id="icon">
                    <div class="profile-icon">
                        <span class="icon">account_circle</span>
                    </div>
                </a>
                <div id="navbarLinks">
                    <a onclick="logOut()">Log out</a>
                </div>
            </div>
        </div>

        <div class="app-nav" id="nav">
            <a href="./dashboard.html"><div class="nav-entry nav-current" -icon="dashboard" -name="Dashboard"></div></a>
            <a href="./account.html"><div class="nav-entry" -icon="account_circle" -name="Account"></div></a>
            <a href="./data_reports.html"><div class="nav-entry" -icon="file_upload" -name="Data"></div></a>
            <a href="./settings.html"><div class="nav-entry" -icon="tune" -name="Settings"></div></a>
            <a href="./admin_overview.html"><div class="nav-entry" -icon="admin_panel_settings" -name="Admin"></div></a>
        </div>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
            </div>

        </main>

        <div class="app-content" id="app">
            <div class="flex vertical-700">

                <!-- DASHBOARD INFO -->
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-header">TO BE IMPLEMENTED</div>
                        <div class="card-content">
                            Examples:
                        </div>
                        <div class="card-content">
                            One specific store ID with most stolen items or one specific category with most stolen items in certain week.
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">TO BE IMPLEMENTED</div>
                        <div class="card-content">
                            Examples:
                        </div>
                        <div class="card-content">
                            Average cost of a stolen item or total loss in certain time period.
                        </div>
                    </div>
                </div>

                <!-- CHART -->
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-image" id="chart-canvas-1" style="height: 400px">
                        </div>
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|article.category|-1|article|-0-1|article.category|-0-1|article.category|-0",
                                    success: function(response) {
                                        let array = [[
                                            'Category', 'Amount',
                                        ]];
                                        for (let item of response){
                                            array.push([item.category, item.count, ]);
                                        }
                                        let data = google.visualization.arrayToDataTable(array);
                                        let options = {
                                            backgroundColor: {
                                                fill: '#F4F4F4'
                                            },
                                            colors: ['#2C7998'],
                                            chartArea: {
                                                top: 20,
                                                height: '80%',
                                                width: '85%'
                                            },
                                            hAxis: {
                                                gridlines: {
                                                    count: 0
                                                },
                                                viewWindow: {
                                                    min: 0,
                                                    max: 63
                                                },
                                                showTextEvery: 1,
                                                title: 'Category Number'
                                            },
                                            vAxis: {
                                                viewWindow: {
                                                    max: 1600
                                                }
                                            },
                                            legend: {
                                                position: 'none'
                                            }
                                        };
                                        let chart = new google.visualization.ColumnChart(document.getElementById('chart-canvas-1'));

                                        chart.draw(data, options);
                                    }
                                });

                            });
                        </script>
                        <div class="card-header">Stolen items</div>
                        <div class="card-content">
                            An overview of all items ever stolen.
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex vertical-800">
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-image" id="chart-canvas-2" style="height: 400px">
                        </div>
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|article.price|-1|article|-0-1|article.price|-0-1|article.price|-0",
                                    success: function(response) {
                                        let array = [[
                                            {label: 'Price', type: 'number'},
                                            {label: 'Amount', type: 'number'},
                                        ]];
                                        for (let item of response){
                                            if (item.count > 50 && item.price > 0) {
                                                array.push([Math.round(item.price), item.count]);
                                            }
                                        }
                                        let data = google.visualization.arrayToDataTable(array);
                                        let formatter = new google.visualization.NumberFormat({prefix: '€'});
                                        formatter.format(data, 0);
                                        let options = {
                                            backgroundColor: {
                                                fill: '#F4F4F4'
                                            },
                                            colors: ['#2C7998'],
                                            chartArea: {
                                                top: 20,
                                                height: '80%',
                                                width: '85%'
                                            },
                                            hAxis: {
                                                gridlines: {
                                                    count: 0
                                                },
                                                viewWindow: {
                                                    min: 0,
                                                    max: 300
                                                },
                                                showTextEvery: 1,
                                                title: 'Price in €'
                                            },
                                            legend: {
                                                position: 'none'
                                            },
                                            bar: {
                                                groupWidth: 5
                                            },
                                        };
                                        let chart = new google.visualization.ColumnChart(document.getElementById('chart-canvas-2'));

                                        chart.draw(data, options);
                                    }
                                });

                            });
                        </script>
                        <div class="card-header">Stolen items at price</div>
                        <div class="card-content">
                            An overview of all things stolen at a set price.
                        </div>
                    </div>
                </div>

                <div class="flex vertical">
                    <div class="card">
                        <div class="card-image" id="chart-canvas-3" style="height: 400px">
                        </div>
                        <script>
                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|alarm.store_id|-2|alarm:article|-1|article.id:=:alarm.article_id|-1|alarm.store_id|-0-1|alarm.store_id|-0",
                                    success: function(response) {
                                        let array = [[
                                            'Store', 'Amount',
                                        ]];
                                        for (let item of response){
                                            array.push([item.store_id.toString(), item.count]);
                                        }
                                        let data = google.visualization.arrayToDataTable(array);
                                        let options = {
                                            backgroundColor: {
                                                fill: '#F4F4F4'
                                            },
                                            colors: ['#2C7998'],
                                            chartArea: {
                                                top: 20,
                                                height: '65%',
                                                width: '75%'
                                            },
                                            hAxis: {
                                                title: 'Store ID',
                                                slantedText: true,
                                                slantedTextAngle: 90,
                                                showTextEvery: 1
                                            },
                                            bar: {
                                                groupWidth: 3
                                            },
                                            legend: {
                                                position: 'none'
                                            },

                                        };
                                        let chart = new google.visualization.ColumnChart(document.getElementById('chart-canvas-3'));

                                        chart.draw(data, options);
                                    }
                                });

                            });
                        </script>
                        <div class="card-header">Stolen items at each store</div>
                        <div class="card-content">
                            An overview of all items ever stolen for each store.
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div id="mapid" style="height: 400px"></div>
                <script>
                   $.ajax({
                        url: "rest/app",
                        method: 'POST',
                        dataType: 'json',
                        data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-2-1|store|-0-0-0-0-0",
                        success: function(locationResult) {
                            let array = [[
                                {label: 'Store ID', type: 'number'},
                                {label: 'Longitude', type: 'number'},
                                {label: 'Latitude', type: 'number'},
                            ]];
                            for (let item of locationResult){
                                array.push([item.store_id, item.longitude, item.latitude]);
                            }
                            var mapData = locationResult;

                            let grouped = {};

                            for (let d of mapData) {
                                if (d.latitude !== null && d.longitude !== null) {
                                    let key = d.latitude + ";" + d.longitude;

                                    let collection = grouped[key];
                                    if (!collection) {
                                        collection = {coords: [d.latitude, d.longitude], ids: []};
                                    }

                                    collection.ids.push(d.store_id);
                                    grouped[key] = collection;
                                }
                            }


                            var mymap = L.map('mapid').setView([38.3, -3.5], 4);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(mymap);

                            for (let k in grouped) {
                                let d = grouped[k];
                                let icon = d.ids.length === 1 ? markerIcons[Math.floor(Math.random() * 4)] : multiMarkerIcon;
                                let marker = L.marker(d.coords, {icon: icon}).addTo(mymap);

                                let idHtml = "<b>" + d.ids.length + " store" + (d.ids.length === 1 ? "" : "s") + "</b>"

                                for (let id of d.ids) {
                                    idHtml += "<br>" + id;
                                }

                                marker.bindPopup(idHtml);
                            }
                        }
                   })
                </script>
                <div class="card-header">Map</div>
            </div>
        </div>

        <div class="modal" id="test-modal">
            <div class="card card-error">
                <div class="card-header">I'm a big and important modal</div>
                <div class="card-content">
                    This is a big warning modal that wants you to be sure you have seen my information.
                </div>
                <div class="card-content align-right">
                    <button class="btn-primary" onclick="app.hideModal(this)">Close</button>
                </div>
            </div>
        </div>

        <div class="snackbar-container">
        </div>
    </body>
</html>
