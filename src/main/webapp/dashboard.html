<!DOCTYPE html>
<html class="app-html" lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="font/fonts.css">
        <link rel="stylesheet" href="css/main.css">
        <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script src="js/jquery.js"></script>
        <script src="js/commandbar.js"></script>
        <script src="js/app.js"></script>
        <script src="js/chart.js"></script>
        <script src="js/sorttable.js"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

        <title>Dashboard</title>

        <style>
            .logo::before {
                display: block;
                width: 100%;
                height: 100%;
                background-image: url("svg/nedap_inline_logo_on_blue.svg");
                background-position: center;
                background-size: contain;
                background-repeat: no-repeat;
                content: "";
                box-sizing: border-box;
                border: 10px solid transparent;
            }
            #navbarLinks {
                display: none;
                min-width: 0;
                text-align: center;
                vertical-align: middle;
                background-color: #023A4F;

            }
            #navbarLinks a {
                text-decoration: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                display: table-cell;
                position: relative;
                vertical-align: middle;
                font-size: 20px;
                background-color: #023A4F;
                color: white;
            }
            #navbarLinks a:hover {
                background-color: #01151d;
            }
            #icon {
                position: relative;
                float: right;
                color: white;
                background-color: #FF6C37;
            }
            #icon:hover {
                background-color: #FF4710;
            }
            #icon div {
                text-align: center;
            }
            #icon div span {
                font-size: 48px;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        </style>

        <script>
            // Map marker icons
            const s = 2;
            const blueMarkerIcon = L.icon({
                iconUrl: 'icons/blue_map_marker.png',
                iconSize: [24*s, 24*s],
                iconAnchor: [12*s, 22*s],
                popupAnchor: [0, -20*s]
            });
            const redMarkerIcon = L.icon({
                iconUrl: 'icons/red_map_marker.png',
                iconSize: [24*s, 24*s],
                iconAnchor: [12*s, 22*s],
                popupAnchor: [0, -20*s]
            });
            const greenMarkerIcon = L.icon({
                iconUrl: 'icons/green_map_marker.png',
                iconSize: [24*s, 24*s],
                iconAnchor: [12*s, 22*s],
                popupAnchor: [0, -20*s]
            });
            const yellowMarkerIcon = L.icon({
                iconUrl: 'icons/yellow_map_marker.png',
                iconSize: [24*s, 24*s],
                iconAnchor: [12*s, 22*s],
                popupAnchor: [0, -20*s]
            });
            const multiMarkerIcon = L.icon({
                iconUrl: 'icons/multi_map_marker.png',
                iconSize: [24*s, 24*s],
                iconAnchor: [12*s, 22*s],
                popupAnchor: [0, -20*s]
            });
            const markerIcons = [blueMarkerIcon, redMarkerIcon, greenMarkerIcon, yellowMarkerIcon];
        </script>
    </head>

    <body class="app">
        <div class="app-bar">
            <div class="app-bar-inner" style="display: inline-flex">
                <div class="logo"> </div>
                <input class="searchbar" id="searchbar" type="text" placeholder="Type here to search">
                <a onclick="navbarMenu()" id="icon">
                    <div class="profile-icon">
                        <span class="icon">account_circle</span>
                    </div>
                </a>
                <div id="navbarLinks">
                    <a>[Log out]</a>
                </div>
            </div>
        </div>

        <div class="app-nav" id="nav">
            <a href="./dashboard.html"><div class="nav-entry nav-current" -icon="dashboard" -name="Dashboard"></div></a>
            <a href="./account.html"><div class="nav-entry" -icon="account_circle" -name="Account"></div></a>
            <a href="./data_reports.html"><div class="nav-entry" -icon="file_upload" -name="Data"></div></a>
            <div class="nav-entry" -icon="table_view" -name="Reports"></div>
            <a href="./settings.html"><div class="nav-entry" -icon="tune" -name="Settings"></div></a>
            <a href="./admin_overview.html"><div class="nav-entry" -icon="admin_panel_settings" -name="Admin"></div></a>
            <div class="nav-section" -name="Saved reports"></div>
            <div class="nav-entry" -icon="insert_drive_file" -name="Current month"></div>
            <div class="nav-entry" -icon="insert_drive_file" -name="Last quartile"></div>
        </div>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
            </div>

        </main>

        <div class="app-content" id="app">
            <div class="flex vertical-700">

                <!-- DASHBOARD INFO -->
                <div class="flex vertical">
                    <div class="card">
                        <div class="card-header">
                            Welcome <span -inject="user.username"></span>!
                        </div>
                        <div class="card-content">
                            Some dashboard information appears here.
                        </div>
                        <div class="card-table">
                            <table class="sortable"> <!--sortable class adds automatic sorting-->
                                <thead>
                                    <tr><td>A</td><td>B</td><td>C</td></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Hello</td><td>132</td><td>XB</td></tr>
                                    <tr><td>World</td><td>124</td><td>B</td></tr>
                                    <tr><td>Foo</td><td>812</td><td>XB</td></tr>
                                    <tr><td>Bar</td><td>241</td><td>XS</td></tr>
                                    <tr><td>Baz</td><td>341</td><td>M</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CHART -->
                <div class="flex vertical">
                    <div class="card">
                        <canvas class="card-image" id="chart-canvas" style="width: 100%; height: 400px;">
                        </canvas>
                        <script>

                            // (function(){
                            //     let chart = new PieChart(document.getElementById("chart-canvas"), {margin: 30, hollow: 0.7, angle: -45});
                            //     chart.updateData("a", app.graphColors[0], 241);
                            //     chart.updateData("b", app.graphColors[1], 621);
                            //     chart.updateData("c", app.graphColors[2], 512);
                            //     chart.updateData("d", app.graphColors[3], 119);
                            //     chart.updateData("e", app.graphColors[4], 571);
                            //     chart.redraw();
                            // })();

                            window.addEventListener("load", function(){
                                $.ajax({
                                    url: "rest/app",
                                    method: 'POST',
                                    dataType: 'text',
                                    data: "SELECT array_to_json(array_agg(t)) FROM ( ? ) AS t;1-1|article.category|-1|article|-0-1|article.category|-0-1|article.category|-0",
                                    success: function(response) {
                                        // console.log("response: " + typeof(response) + " = " + response);
                                        response = JSON.parse(response);
                                        console.log(response);
                                        let array = [[
                                            {label: 'Count', type: 'number'},
                                            {label: 'Category', type: 'number'},
                                        ]];
                                        for (let item of response){
                                            array.push([item.count, item.category]);
                                        }

                                        console.log(array);

                                        let chart = new BarChart(document.getElementById("chart-canvas"), {margin: 30, hollow: 0.7, angle: -45});
                                        chart.addId("a", app.graphColors[0]);
                                        chart.addId("b", app.graphColors[1]);
                                        chart.setLabels("2016", "2017", "2018", "2019", "2020", "2021")
                                        chart.updateData("a", 42, 281, 102, 37, 184, 212);
                                        chart.updateData("b", 412, 211, 41, 174, 381, 121);
                                        chart.redraw();

                                        console.log("end method")
                                    }
                                });







                            });

                            // app.drawChart(function() {
                            //     var data = google.visualization.arrayToDataTable([
                            //         ['Year', 'Items Found', 'Items Lost'],
                            //         ['2016',         1020 ,         590 ],
                            //         ['2017',          910 ,         720 ],
                            //         ['2018',         1000 ,         400 ],
                            //         ['2019',         1170 ,         460 ],
                            //         ['2020',          660 ,        1120 ],
                            //         ['2021',         1030 ,         540 ]
                            //     ]);

                            //     var options = {
                            //         title: 'Company Performance',
                            //         hAxis: {title: 'Year',  titleTextStyle: {color: '#333'}},
                            //         vAxis: {minValue: 0},
                            //         colors: app.graphColors
                            //     };

                            //     var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
                            //     chart.draw(data, options);
                            // });
                        </script>
                        <div class="card-header">Chart</div>
                        <div class="card-content">
                            Information about chart. Lorem ipsum.
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div id="mapid" style="height: 400px;"></div>
                <script>
                    var mapData = [
                        {"id":1023553,"latitude":43,"longitude":-3},
                        {"id":1023625,"latitude":37,"longitude":-5},
                        {"id":1023401,"latitude":41,"longitude":-4},
                        {"id":1023627,"latitude":37,"longitude":-4},
                        {"id":1023507,"latitude":40,"longitude":-4},
                        {"id":1023445,"latitude":39,"longitude":0},
                        {"id":1023515,"latitude":40,"longitude":-4},
                        {"id":1023617,"latitude":37,"longitude":-4},
                        {"id":1023619,"latitude":37,"longitude":-6},
                        {"id":1023623,"latitude":38,"longitude":-5},
                        {"id":1023449,"latitude":42,"longitude":-1},
                        {"id":1023409,"latitude":40,"longitude":-4},
                        {"id":1023411,"latitude":40,"longitude":-4},
                        {"id":1023417,"latitude":41,"longitude":-4},
                        {"id":1023573,"latitude":43,"longitude":-6},
                        {"id":1023455,"latitude":38,"longitude":0},
                        {"id":1023575,"latitude":43,"longitude":-8},
                        {"id":1023511,"latitude":43,"longitude":-6},
                        {"id":1023457,"latitude":41,"longitude":2},
                        {"id":1023421,"latitude":40,"longitude":3},
                        {"id":1023571,"latitude":42,"longitude":-9},
                        {"id":1023425,"latitude":39,"longitude":-7},
                        {"id":1023423,"latitude":40,"longitude":-4},
                        {"id":1026517,"latitude":41,"longitude":-9},
                        {"id":1040895,"latitude":null,"longitude":null},
                        {"id":1023577,"latitude":43,"longitude":-4},
                        {"id":1025545,"latitude":42,"longitude":-5},
                        {"id":1025547,"latitude":null,"longitude":null},
                        {"id":1025549,"latitude":39,"longitude":0},
                        {"id":1026645,"latitude":40,"longitude":-4},
                        {"id":1028361,"latitude":41,"longitude":1},
                        {"id":1028363,"latitude":null,"longitude":null},
                        {"id":1026599,"latitude":41,"longitude":-4},
                        {"id":1031217,"latitude":40,"longitude":3},
                        {"id":1031551,"latitude":40,"longitude":-4},
                        {"id":1033615,"latitude":41,"longitude":-4},
                        {"id":1036171,"latitude":37,"longitude":-4},
                        {"id":1039143,"latitude":37,"longitude":-2},
                        {"id":1039621,"latitude":42,"longitude":-4},
                        {"id":1039623,"latitude":40,"longitude":-4},
                        {"id":1040891,"latitude":42,"longitude":-1},
                        {"id":1043925,"latitude":37,"longitude":-5},
                        {"id":1044341,"latitude":42,"longitude":-2},
                        {"id":1044871,"latitude":40,"longitude":-4},
                        {"id":1044937,"latitude":38,"longitude":-5},
                        {"id":1047191,"latitude":39,"longitude":-2},
                        {"id":1047859,"latitude":28,"longitude":-15},
                        {"id":1047861,"latitude":38,"longitude":0},
                        {"id":1051285,"latitude":43,"longitude":-6},
                        {"id":1051759,"latitude":37,"longitude":-6},
                        {"id":1052291,"latitude":40,"longitude":-4},
                        {"id":1054633,"latitude":42,"longitude":-5},
                        {"id":1055515,"latitude":40,"longitude":-4}
                    ];

                    let grouped = {};

                    for (let d of mapData) {
                        if (d.latitude !== null && d.longitude !== null) {
                            let key = d.latitude + ";" + d.longitude;

                            let collection = grouped[key];
                            if (!collection) {
                                collection = {coords: [d.latitude, d.longitude], ids: []};
                            }

                            collection.ids.push(d.id);
                            grouped[key] = collection;
                        }
                    }


                    var mymap = L.map('mapid').setView([52.238234, 6.854233], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(mymap);

                    for (let k in grouped) {
                        let d = grouped[k];

                        let icon = d.ids.length === 1 ? markerIcons[Math.floor(Math.random() * 4)] : multiMarkerIcon;
                        let marker = L.marker(d.coords, {icon: icon}).addTo(mymap);

                        let idHtml = "<b>" + d.ids.length + " store" + (d.ids.length === 1 ? "" : "s") + "</b>"

                        for (let id of d.ids) {
                            idHtml += "<br>" + id;
                        }

                        marker.bindPopup(idHtml);
                    }
                </script>
                <div class="card-header">Map</div>
            </div>
        </div>

        <div class="modal" id="test-modal">
            <div class="card card-error">
                <div class="card-header">I'm a big and important modal</div>
                <div class="card-content">
                    This is a big warning modal that wants you to be sure you have seen my information.
                </div>
                <div class="card-content align-right">
                    <button class="btn-primary" onclick="app.hideModal(this)">Close</button>
                </div>
            </div>
        </div>

        <div class="snackbar-container">
        </div>

        <script src="js/commands.js"></script>
        <script>
            $(function() {
                makeCommandBar({
                    element: document.getElementById("searchbar")
                });

                app.inject("user.username", "Four-Zero-Four");
            });
            function navbarMenu() {
                let links = document.getElementById("navbarLinks");
                if (links.style.display === "table") {
                    links.style.display = "none";
                    links.style.minWidth = "0px";
                } else {
                    links.style.display = "table";
                    links.style.minWidth = "100px";
                }
            }
        </script>
    </body>
</html>
